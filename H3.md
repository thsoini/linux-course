# H3 Infraa koodina üòß

## Lue ja tiivist√§ üìñ

### [Karvinen 2014: Hello Salt Infra-as-Code](https://terokarvinen.com/2024/hello-salt-infra-as-code/)

- Tee omat kansiot jokaiselle init.sls tiedostolle, jotta se on selke√§
<pre>
/srv/salt/
‚îú‚îÄ‚îÄ hello/
‚îÇ   ‚îî‚îÄ‚îÄ init.sls
‚îú‚îÄ‚îÄ pkg/
‚îÇ   ‚îî‚îÄ‚îÄ init.sls
‚îî‚îÄ‚îÄ file/
    ‚îî‚îÄ‚îÄ init.sls
</pre>

- hello sis√§ll√§ oleva init.sls ajetaan paikallisesti komennolla `sudo salt-call --local state.apply hello`


### Salt contributors: Salt overview, kohdat
#### [Rules of YAML](https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml)

- K√§yt√§ v√§lily√∂ntej√§ tabulaattorin sijasta.

- Kommentit eiv√§t vaikuta ohjelman toimintaan. Ne alkavat aina #merkill√§.

```yaml
/tmp/hellotommy # :DDDDDDDDDDD 
  file.managed
```

#### [YAML simple structure](https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#yaml-simple-structure)
- Scalar: Avain ja yksitt√§inen arvo esim. vihannekset: herneet.
- Lists: Lista asioita esim. vihannekset: herneet, porkkanat.
- Dictionary: Useita avaimia ja arvoja esim. illallinen: alkupala, p√§√§ruoka, j√§lkiruoka.

#### [Lists and dictionaries - YAML block structures](https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#lists-and-dictionaries-yaml-block-structures)
- YAML on lohkoihin perustuva tietomuoto, jossa sisennys m√§√§ritt√§√§ kontekstin. Ominaisuudet ja listat t√§ytyy sisent√§√§ tavallisesti kahdella v√§lily√∂nnill√§.
- Kokoelmat, kuten listat ja sanakirjat, merkit√§√§n viivalla ja v√§lily√∂nnill√§ 
```yaml
Fruits: # Miten lista kuuluu tehd√§ k√§ytt√§en Yaml block structures.
  - Apple
  - Banana
```

```yaml
henkil√∂: # Dictionaries tapahtuu taas t√§ll√§ tavalla.
  nimi: "Esimerkki"
  ik√§: 50
  ammatti: "Timpuri"
```

## a) Paikallisesti. üë®

Edelliseen teht√§v√§√§n viitaten [H2 Soitto kotiin](https://github.com/thsoini/linux-course/blob/main/H2.md#h2-soitto-kotiin) t√§ss√§ teht√§v√§ss√§ k√§ytet√§√§n samaa ymp√§rist√∂√§, Vagrant + Linux virtuaalikoneet Debian/Bookworm64
Teht√§v√§n aloitus `vagrant up` & `vagrant ssh [koneen nimi]`

Ensimm√§iseksi loin polun `sudo mkdir -p /srv/salt/hello/` jonka j√§lkeen siirryin kyseiseen hakemistoon k√§ytt√§en `cd /srv/salt/hello/`
- ![image](https://github.com/user-attachments/assets/c8b98984-3f4c-4001-90f4-5c8da8fd1bb3)

T√§m√§n j√§lkeen siirryin teksti-editoriin ja lis√§sin tyhj√§√§n tiedostoon m√§√§rityksen, jolla Salt hallitsee /tmp/hellosteffe-tiedoston olemassaoloa ja sis√§lt√∂√§. `sudoedit init.sls`

- ![image](https://github.com/user-attachments/assets/b4bb5fc2-913f-456e-8e8b-610927af13b9)
-  K√§ytin Teron sivuilta l√∂ytyv√§√§ [init.sls tiedoston sis√§lt√∂√§](https://terokarvinen.com/2024/hello-salt-infra-as-code/#:~:text=/tmp/hellotero%3A,file.managed)
```yaml
/tmp/hellotero:
  file.managed
```
-  Teht√§v√§ss√§ kokeilin Micro-nimist√§ tekstieditoria. Teht√§v√§n ainoa ongelma oli se, ett√§ olen tottunut Nanoon, ja `Ctrl + X` ei toiminut kyseisest√§ editorista poistumiseksi.
-  Editorista p√§√§see ulos k√§ytt√§m√§ll√§ `Ctrl + Q`.

- Nyt, kun olin saanut tiedostoon sis√§lt√∂√§, oli aika kokeilla sen toimivuutta komennolla. `sudo salt-call --local state.apply hello`

- ![image](https://github.com/user-attachments/assets/b51ef1da-d74b-441e-8c62-eb002f90fc63)
- Salt loi tyhj√§n tiedoston /tmp/hellosteÔ¨Äe, koska tiedostossa ei ollut m√§√§ritelty mit√§√§n tiedoston sis√§lt√∂√§.

---------------------------------------------------------------------------------------------------------------------

## B) Verkon yli orjalla. üßô‚Äç‚ôÇÔ∏è

Aikaisemmassa [H2 Teht√§v√§ss√§](https://github.com/thsoini/linux-course/blob/main/H2.md#c-kaksin-kaunihimpi-tee-kahden-linux-tietokoneen-verkko-vagrantilla-osoita-ett%C3%A4-koneet-voivat-pingata-toisiaan) tein Salt-Masterin ja Salt-Minionin ja k√§ytin t√§ss√§ teht√§v√§ss√§ samoja koneita.

- K√§ytin komentoa `sudo salt '*' state.apply hello`
- ![image](https://github.com/user-attachments/assets/460d07d2-a18c-42bf-ae07-6ea954dc94ff)
- Minion suoritti annetun k√§skyn ja loi tiedoston nimelt√§ /tmp/hellotommy, kuten changes-kohdassa ilmoitetaan

Alla muutokset mit√§ tein sls tiedoston sis√§√§n.

```yaml
/tmp/hellotommy
  file.managed
```

-------------------------------------------------------------------------------------------------------------------------------

## C) SLS tiedosto, üìÅ

Tein kokonaan uuden polun `sudo mkdir -p /srv/salt/salt/tilat/` t√§m√§n, j√§lkeen siirryin polkuun `cd /srv/salt/tilat/` jonka j√§lkeen tein sls tiedoston k√§ytt√§en komentoa `sudoedit init.sls` 
- ![image](https://github.com/user-attachments/assets/0a60db81-663d-4a3a-866c-c10b51dcb5cd)


Ohjeistu kyseiseen sls tiedostoon saatu [salt.states.pkg](https://docs.saltproject.io/en/master/ref/states/all/salt.states.pkg.html#module-salt.states.pkg)

```yaml
Lataa ohjelmat:
  pkg.installed:
    -pkgs:
       - tree
       - curl
```

Tiedosto tallennettu ja p√§√§sty ulos, komento `sudo salt '*' state.sls tilat`

![image](https://github.com/user-attachments/assets/26f30837-2487-4a79-856d-c7c464c32c57)

T√§m√§n j√§lkeen lis√§sin [file](https://docs.saltproject.io/salt/user-guide/en/latest/topics/states.html#create-a-disable-usb-storage-state) tilafunktion, 

```yaml
Lataa ohjelmat:
  pkg.installed:
    -pkgs:
       - tree
       - curl

/tmp/hellosteffe:
  file.managed:
    - contents: |
       Testi123
```
- file.managed alapuolelle lis√§tty tietoa, jotta alla oleva warning h√§vi√§√§.
- ![image](https://github.com/user-attachments/assets/98116d3d-3a06-4d0e-8142-a2f5c1beebf5)

K√§ytin komentoa `sudo salt '*' state.sls tilat` 

- ![image](https://github.com/user-attachments/assets/0f208d93-47ed-4ae0-a510-9dcf552cc113)


Halusin viel√§ lis√§t√§ kolmannen tilafunktion sls tiedostoon mik√§ oli [service](https://docs.saltproject.io/en/3006/ref/states/all/salt.states.service.html) 
- Komennolla `systemctl list-units --type=service` Sain selville, mitk√§ sovellukset olivat kyseisell√§ hetkell√§ k√§ynniss√§.
- ![image](https://github.com/user-attachments/assets/653d9e7d-4113-4f3a-93df-af70f9e46f17)

```yaml
Lataa ohjelmat:
  pkg.installed:
    -pkgs:
       - tree
       - curl

/tmp/hellosteffe:
  file.managed:
    - contents: |
       Testi123

dbus active?:
  service.running:
    - name: dbus
    - name: True
```

### Saman komennon ajaminen.

Ensimm√§inen `sudo salt '*' state.sls tilat`
- ![image](https://github.com/user-attachments/assets/04600193-bfb4-4719-9abf-4dd3489ffc1e)

Toinen `sudo salt '*' state.sls tilat`
- ![image](https://github.com/user-attachments/assets/89d52a10-78f8-45f8-b32b-ffa3aac4154a)

Viides `sudo salt '*' state.sls tilat` Seuraavilla ajokerroilla mit√§√§n ei en√§√§ tapahtunut Salt ilmoitti, ett√§ kaikki on jo kunnossa ja muutoksia ei ole tapahtunut.  
- ![image](https://github.com/user-attachments/assets/14415439-7b24-4b81-acbe-16073b7cb35c)

Koska ajon aikana ei tapahtunut en√§√§ muutoksia, voidaan todeta, ett√§ tilatiedosto on idempotentti ‚úÖ 







## L√§hteet 

Kurssi: Palvelinten Hallinta 2025. https://terokarvinen.com/palvelinten-hallinta/

Karvinen. 2024. Hello Salt Infra-as-Code https://terokarvinen.com/2024/hello-salt-infra-as-code/ 

Salt Project. salt.states.pkg. https://docs.saltproject.io/en/master/ref/states/all/salt.states.pkg.html#module-salt.states.pkg

Salt Project. salt.states.service. https://docs.saltproject.io/en/3006/ref/states/all/salt.states.service.html

Salt Project. Salt states. https://docs.saltproject.io/salt/user-guide/en/latest/topics/states.html#create-a-disable-usb-storage-state

H2 Teht√§v√§ https://github.com/thsoini/linux-course/blob/main/H2.md#h2-soitto-kotiin

